import boto3
from sagemaker.lambda_helper import Lambda
from sagemaker.workflow.lambda_step import LambdaStep
from sagemaker.workflow.pipeline import Pipeline

deploy_lambda = Lambda(
    function_name=f"{PROJECT_NAME}-deploy-mme",
    execution_role_arn=role_arn,
    script="deploy_mme_lambda.py",
    handler="handler",
    timeout=900,
    memory_size=512,
)

deploy_step = LambdaStep(
    name="DeployMME",
    lambda_func=deploy_lambda,
    inputs={
        "ClientName": CLIENT_NAME,
        "TargetsCSV": ",".join(TARGET_COLS),
        "ModelsPrefix": f"s3://{BUCKET}/{OUTPUT_PREFIX}/mme/{CLIENT_NAME}/models/",
        "EndpointName": f"{CLIENT_NAME}-mme-endpoint",
        "InstanceType": "ml.m5.large",
        "InstanceCount": 1,
        "ExecRoleArn": role_arn,
    }
)

pipeline_b = Pipeline(
    name=f"{PROJECT_NAME}-pipeline-B",
    parameters=[],
    steps=[deploy_step],
    sagemaker_session=p_sess,
)

pipeline_b.upsert(role_arn=role_arn)
execution = pipeline_b.start()
print("Started Pipeline B:", execution.arn)
