from sagemaker.lambda_helper import Lambda
from sagemaker.workflow.lambda_step import LambdaStep, LambdaOutput, LambdaOutputTypeEnum

deploy_lambda = Lambda(
    function_name=f"{PROJECT_NAME}-deploy-mme",
    execution_role_arn=role_arn,
    script="deploy_mme_lambda.py",
    handler="deploy_mme_lambda.handler",
    timeout=900,
    memory_size=512,
)

targets_csv = ",".join(TARGET_COLS)
mme_prefix = f"s3://{BUCKET}/{OUTPUT_PREFIX}/mme/{CLIENT_NAME}/models/"

deploy_step = LambdaStep(
    name="DeployMME_XGBoost",
    lambda_func=deploy_lambda,
    inputs={
        "EndpointName": f"{PROJECT_NAME}-mme-endpoint",
        "ModelsPrefix": mme_prefix,
        "ClientName": CLIENT_NAME,
        "TargetsCSV": targets_csv,
        "InstanceType": "ml.m5.large",
        "InstanceCount": "1",
        "ExecRoleArn": role_arn,
    },
    outputs=[LambdaOutput("status", LambdaOutputTypeEnum.String)]
)

pipeline_b = Pipeline(
    name=f"{PROJECT_NAME}-pipeline-deploy-mme",
    parameters=[],
    steps=[deploy_step],
    sagemaker_session=p_sess,
)

pipeline_b.upsert(role_arn=role_arn)
execution = pipeline_b.start()
print("Started Pipeline B:", execution.arn)
