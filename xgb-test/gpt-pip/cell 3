%%writefile train.py
import pandas as pd
import xgboost as xgb
import json
import os

def main():

    # -------------------------
    # Load training and val CSV
    # -------------------------
    train_path = "/opt/ml/input/data/train/train.csv"
    val_path   = "/opt/ml/input/data/val/val.csv"
    model_dir  = "/opt/ml/model"

    train = pd.read_csv(train_path)
    val   = pd.read_csv(val_path)

    y_train = train["label"]
    y_val   = val["label"]

    X_train = train.drop(columns=["label"]).values
    X_val   = val.drop(columns=["label"]).values

    # -------------------------
    # Encode labels (0..num_class-1)
    # -------------------------
    classes = sorted(y_train.unique())
    class_to_idx = {c: i for i, c in enumerate(classes)}

    y_train_idx = y_train.map(class_to_idx)
    y_val_idx   = y_val.map(class_to_idx)

    num_class = len(classes)

    dtrain = xgb.DMatrix(X_train, label=y_train_idx)
    dval   = xgb.DMatrix(X_val, label=y_val_idx)

    # -------------------------
    # Hyperparameters
    # -------------------------
    params = dict(
        objective="multi:softprob",
        eval_metric="mlogloss",
        num_class=num_class,
        max_depth=8,
        eta=0.2,
        subsample=0.8,
        colsample_bytree=0.8
    )

    # -------------------------
    # Train
    # -------------------------
    model = xgb.train(
        params=params,
        dtrain=dtrain,
        num_boost_round=200,
        evals=[(dval, "validation")]
    )

    # -------------------------
    # Save model + class map
    # -------------------------
    os.makedirs(model_dir, exist_ok=True)
    model.save_model(os.path.join(model_dir, "xgboost-model"))

    with open(os.path.join(model_dir, "class_map.json"), "w") as f:
        json.dump(class_to_idx, f)

if __name__ == "__main__":
    main()
