%%writefile train.py
import json
import xgboost as xgb
import os
import numpy as np

def main():
    train_path = "/opt/ml/input/data/train/train"
    val_path   = "/opt/ml/input/data/val/val"
    model_dir  = "/opt/ml/model"
    os.makedirs(model_dir, exist_ok=True)

    # Load LIBSVM files
    dtrain = xgb.DMatrix(train_path)
    dval   = xgb.DMatrix(val_path)

    y_train = dtrain.get_label()
    y_val   = dval.get_label()

    all_classes = sorted(set(list(y_train) + list(y_val)))
    class_map = {str(cls): i for i, cls in enumerate(all_classes)}

    with open(os.path.join(model_dir, "class_map.json"), "w") as f:
        json.dump(class_map, f, indent=2)

    def encode_labels(dmat):
        raw = dmat.get_label()
        mapped = np.array([class_map[str(lbl)] for lbl in raw])
        dmat.set_label(mapped)

    encode_labels(dtrain)
    encode_labels(dval)

    params = {
        "objective": "multi:softprob",
        "num_class": len(class_map),
        "eval_metric": "mlogloss",
        "tree_method": "hist",
        "max_depth": 8,
        "eta": 0.2,
    }

    booster = xgb.train(
        params=params,
        dtrain=dtrain,
        num_boost_round=200,
        evals=[(dtrain, "train"), (dval, "validation")]
    )

    booster.save_model(os.path.join(model_dir, "xgboost-model"))
    print("Saved model into", model_dir)

if __name__ == "__main__":
    main()
