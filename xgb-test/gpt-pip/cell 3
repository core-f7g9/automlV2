%%writefile train.py
import json
import xgboost as xgb
import os
import numpy as np

def main():
    train_path = "/opt/ml/input/data/train/train.libsvm"
    val_path   = "/opt/ml/input/data/validation/val.libsvm"
    model_dir  = "/opt/ml/model"
    os.makedirs(model_dir, exist_ok=True)

    dtrain = xgb.DMatrix(train_path)
    dval   = xgb.DMatrix(val_path)

    y_train = dtrain.get_label()
    y_val   = dval.get_label()

    # Labels are already encoded to 0..K-1 in preprocess.py
    all_labels = np.unique(np.concatenate([y_train, y_val]))
    num_class = len(all_labels)

    params = {
        "objective": "multi:softprob",
        "num_class": int(num_class),
        "eval_metric": ["mlogloss", "merror"],
        "tree_method": "hist",
        "max_depth": 8,
        "eta": 0.2,
    }

    booster = xgb.train(
        params=params,
        dtrain=dtrain,
        num_boost_round=200,
        evals=[(dtrain, "train"), (dval, "validation")]
    )

    booster.save_model(os.path.join(model_dir, "xgboost-model"))

if __name__ == "__main__":
    main()
