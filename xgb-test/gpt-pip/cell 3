%%writefile train.py
import argparse
import pandas as pd
import xgboost as xgb
import os
import json

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--train_csv")
    parser.add_argument("--val_csv")
    parser.add_argument("--model_dir")
    args = parser.parse_args()

    train = pd.read_csv(args.train_csv)
    val = pd.read_csv(args.val_csv)

    y_train = train["label"]
    y_val = val["label"]

    X_train = train.drop(columns=["label"]).values
    X_val = val.drop(columns=["label"]).values

    # Map labels to 0..num_class-1
    classes = sorted(y_train.unique())
    class_to_idx = {c: i for i, c in enumerate(classes)}
    y_train_idx = y_train.map(class_to_idx)
    y_val_idx = y_val.map(class_to_idx)

    num_class = len(classes)

    dtrain = xgb.DMatrix(X_train, label=y_train_idx)
    dval = xgb.DMatrix(X_val, label=y_val_idx)

    params = dict(
        objective="multi:softprob",
        eval_metric="mlogloss",
        num_class=num_class,
        max_depth=8,
        eta=0.2,
        subsample=0.8,
        colsample_bytree=0.8
    )

    model = xgb.train(
        params, 
        dtrain, 
        num_boost_round=200,
        evals=[(dval, "validation")]
    )

    os.makedirs(args.model_dir, exist_ok=True)
    model.save_model(os.path.join(args.model_dir, "xgboost-model"))

    # Save class mapping
    with open(os.path.join(args.model_dir, "class_map.json"), "w") as f:
        json.dump(class_to_idx, f)

if __name__ == "__main__":
    main()
