# ============================
# CORRECTED MME Deployment - Changed to SKLEARN Container
# ============================
import boto3
import sagemaker

sm_client = boto3.client("sagemaker")
sm_sess = sagemaker.Session()
role = sagemaker.get_execution_role()

PROJECT_PREFIX = "multi-target-xgb"
BUCKET = sm_sess.default_bucket()
MME_PREFIX = f"{PROJECT_PREFIX}/mme-packaged"
MME_S3 = f"s3://{BUCKET}/{MME_PREFIX}/"

ENDPOINT_NAME = "multi-target-xgb-mme-endpoint"
MODEL_NAME = "multi-target-xgb-mme-model"
ENDPOINT_CONFIG_NAME = ENDPOINT_NAME

region = boto3.Session().region_name

# ‚≠ê CRITICAL CHANGE: Using the stable SKLEARN container as the base
container_uri = sagemaker.image_uris.retrieve(
    framework="sklearn",
    region=region,
    version="1.2-1"  # Use a stable version that has scikit-learn
)

# ============================
# Step 1: Create Model
# ============================
try:
    # Delete existing model if you need to update config
    try:
        sm_client.delete_model(ModelName=MODEL_NAME)
        print(f"Deleted existing model: {MODEL_NAME}")
    except:
        pass

    sm_client.create_model(
        ModelName=MODEL_NAME,
        PrimaryContainer={
            'Image': container_uri,
            'ModelDataUrl': MME_S3,
            'Mode': 'MultiModel'
            # Environment block remains removed (correct)
        },
        ExecutionRoleArn=role
    )
    print(f"‚úÖ Created model: {MODEL_NAME}")
except Exception as e:
    print(f"‚ùå Error creating model: {e}")

# ============================
# Step 2: Create Endpoint Configuration
# ============================
try:
    sm_client.create_endpoint_config(
        EndpointConfigName=ENDPOINT_CONFIG_NAME,
        ProductionVariants=[{
            'VariantName': 'AllTraffic',
            'ModelName': MODEL_NAME,
            'InitialInstanceCount': 1,
            'InstanceType': 'ml.m5.xlarge',
            'InitialVariantWeight': 1
        }]
    )
    print(f"‚úÖ Created endpoint config: {ENDPOINT_CONFIG_NAME}")
except sm_client.exceptions.ResourceInUse:
    print(f"‚ö†Ô∏è Endpoint config {ENDPOINT_CONFIG_NAME} already exists")

# ============================
# Step 3: Create Endpoint
# ============================
try:
    sm_client.create_endpoint(
        EndpointName=ENDPOINT_NAME,
        EndpointConfigName=ENDPOINT_CONFIG_NAME
    )
    print(f"‚úÖ Creating endpoint: {ENDPOINT_NAME}")
    print("‚è≥ Waiting for endpoint to be in service (this may take 5-10 minutes)...")
    
    waiter = sm_client.get_waiter('endpoint_in_service')
    waiter.wait(EndpointName=ENDPOINT_NAME)
    print("‚úÖ Endpoint is ready!")
    
except sm_client.exceptions.ResourceInUse:
    print(f"‚ö†Ô∏è Endpoint {ENDPOINT_NAME} already exists")

# ============================
# Step 4: Test Invocation
# ============================
from sagemaker.predictor import Predictor
from sagemaker.serializers import JSONSerializer
from sagemaker.deserializers import JSONDeserializer

predictor = Predictor(
    endpoint_name=ENDPOINT_NAME,
    sagemaker_session=sm_sess,
    serializer=JSONSerializer(),
    deserializer=JSONDeserializer()
)

sample_payload = {
    "VendorName": "Acme Corp",
    "LineDescription": "Office supplies monthly invoice",
    "ClubNumber": 123
}

print("\n" + "="*50)
print("Testing Endpoint")
print("="*50)

target_model = "DepartmentCode.tar.gz"

try:
    response = predictor.predict(sample_payload, target_model=target_model)
    print(f"\n‚úÖ Success! Response:\n{response}")
except Exception as e:
    print(f"\n‚ùå Error: {e}")
    print("\nTroubleshooting: Check CloudWatch logs for the endpoint")

# Test all models
targets = [
    "DepartmentCode.tar.gz",
    "AccountCode.tar.gz", 
    "SubAccountCode.tar.gz",
    "LocationCode.tar.gz"
]

print("\n" + "="*50)
print("Testing All Models")
print("="*50)

for m in targets:
    print(f"\nüìä {m}:")
    try:
        resp = predictor.predict(sample_payload, target_model=m)
        pred = resp.get('prediction', 'N/A')
        probs = resp.get('probabilities', [])
        top_prob = max(probs) if probs else 0
        print(f"  ‚úÖ Prediction: {pred} (confidence: {top_prob:.2%})")
    except Exception as e:
        print(f"  ‚ùå Error: {str(e)[:100]}")