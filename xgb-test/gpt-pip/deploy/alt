# ============================
# Alternative Approach Using Boto3 Directly
# ============================
import boto3
import sagemaker

sm_client = boto3.client("sagemaker")
sm_sess = sagemaker.Session()
role = sagemaker.get_execution_role()

PROJECT_PREFIX = "multi-target-xgb"
BUCKET = sm_sess.default_bucket()
MME_PREFIX = f"{PROJECT_PREFIX}/mme-packaged"
MME_S3 = f"s3://{BUCKET}/{MME_PREFIX}/"

ENDPOINT_NAME = "multi-target-xgb-mme-endpoint"
MODEL_NAME = "multi-target-xgb-mme-model"
ENDPOINT_CONFIG_NAME = ENDPOINT_NAME

region = boto3.Session().region_name

container_uri = sagemaker.image_uris.retrieve(
    framework="xgboost",
    region=region,
    version="1.5-1"
)

# ============================
# Step 1: Create Model with Environment Variables
# ============================
try:
    sm_client.create_model(
        ModelName=MODEL_NAME,
        PrimaryContainer={
            'Image': container_uri,
            'ModelDataUrl': MME_S3,  # This is the prefix for MME
            'Mode': 'MultiModel',
            'Environment': {
                'SAGEMAKER_PROGRAM': 'inference.py',
                'SAGEMAKER_SUBMIT_DIRECTORY': '/opt/ml/model/code',
                'SAGEMAKER_REGION': region
            }
        },
        ExecutionRoleArn=role
    )
    print(f"‚úÖ Created model: {MODEL_NAME}")
except sm_client.exceptions.ResourceInUse:
    print(f"‚ö†Ô∏è Model {MODEL_NAME} already exists")

# ============================
# Step 2: Create Endpoint Configuration
# ============================
try:
    sm_client.create_endpoint_config(
        EndpointConfigName=ENDPOINT_CONFIG_NAME,
        ProductionVariants=[{
            'VariantName': 'AllTraffic',
            'ModelName': MODEL_NAME,
            'InitialInstanceCount': 1,
            'InstanceType': 'ml.m5.xlarge',
            'InitialVariantWeight': 1
        }]
    )
    print(f"‚úÖ Created endpoint config: {ENDPOINT_CONFIG_NAME}")
except sm_client.exceptions.ResourceInUse:
    print(f"‚ö†Ô∏è Endpoint config {ENDPOINT_CONFIG_NAME} already exists")

# ============================
# Step 3: Create Endpoint
# ============================
try:
    sm_client.create_endpoint(
        EndpointName=ENDPOINT_NAME,
        EndpointConfigName=ENDPOINT_CONFIG_NAME
    )
    print(f"‚úÖ Creating endpoint: {ENDPOINT_NAME}")
    print("‚è≥ Waiting for endpoint to be in service...")
    
    waiter = sm_client.get_waiter('endpoint_in_service')
    waiter.wait(EndpointName=ENDPOINT_NAME)
    print("‚úÖ Endpoint is ready!")
    
except sm_client.exceptions.ResourceInUse:
    print(f"‚ö†Ô∏è Endpoint {ENDPOINT_NAME} already exists")

# ============================
# Step 4: Test Invocation
# ============================
from sagemaker.predictor import Predictor
from sagemaker.serializers import JSONSerializer
from sagemaker.deserializers import JSONDeserializer

predictor = Predictor(
    endpoint_name=ENDPOINT_NAME,
    sagemaker_session=sm_sess,
    serializer=JSONSerializer(),
    deserializer=JSONDeserializer()
)

sample_payload = {
    "VendorName": "Acme Corp",
    "LineDescription": "Office supplies monthly invoice",
    "ClubNumber": 123
}

print("\n" + "="*50)
print("Testing Endpoint")
print("="*50)

target_model = "DepartmentCode.tar.gz"
response = predictor.predict(sample_payload, target_model=target_model)
print(f"\n‚úÖ Success! Response:\n{response}")

# Test all models
targets = [
    "DepartmentCode.tar.gz",
    "AccountCode.tar.gz", 
    "SubAccountCode.tar.gz",
    "LocationCode.tar.gz"
]

print("\n" + "="*50)
print("Testing All Models")
print("="*50)

for m in targets:
    print(f"\nüìä {m}:")
    try:
        resp = predictor.predict(sample_payload, target_model=m)
        print(f"  Prediction: {resp.get('prediction')}")
    except Exception as e:
        print(f"  ‚ùå Error: {e}")