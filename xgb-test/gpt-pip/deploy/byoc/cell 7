# ============================
# Deploy custom multi-target XGBoost endpoint (dynamic)
# ============================
import boto3, sagemaker
from sagemaker.model import Model
from sagemaker import get_execution_role

# Reuse existing variables when available
region = region if "region" in globals() else boto3.Session().region_name
sm_sess = sm_session if "sm_session" in globals() else sagemaker.Session()
role = role if "role" in globals() else get_execution_role()

BUCKET = BUCKET if "BUCKET" in globals() else sm_sess.default_bucket()
PROJECT_PREFIX = PROJECT_PREFIX if "PROJECT_PREFIX" in globals() else "multi-target-xgb"

# combined_model_uri was created by build_combined_artifact()
if "combined_model_uri" not in globals():
    raise RuntimeError(
        "combined_model_uri is not defined. Make sure you ran the combine step first."
    )

# ECR image info (same repo name you used in CloudShell)
account_id = boto3.client("sts").get_caller_identity()["Account"]
repo_name = "multi-target-xgb-custom"  # must match CloudShell REPO_NAME

image_uri = f"{account_id}.dkr.ecr.{region}.amazonaws.com/{repo_name}:latest"
print("Using image URI:", image_uri)
print("Using model data URI:", combined_model_uri)

# Dynamic names based on PROJECT_PREFIX
model_name = f"{PROJECT_PREFIX}-custom-model"
endpoint_name = f"{PROJECT_PREFIX}-custom-endpoint"

multi_model = Model(
    image_uri=image_uri,
    model_data=combined_model_uri,
    role=role,
    name=model_name,
    sagemaker_session=sm_sess,
)

predictor = multi_model.deploy(
    endpoint_name=endpoint_name,
    initial_instance_count=1,
    instance_type="ml.m5.xlarge",  # tweak if you want smaller/larger
)

print("âœ… Endpoint deployed:", endpoint_name)
