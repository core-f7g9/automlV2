%%writefile repack_for_mme.py
import argparse
import os
import tarfile
import shutil
import glob

def safe_extract_tar(path, dest):
    if not os.path.exists(path):
        print(f"[WARN] Missing tar file: {path}")
        return False
    with tarfile.open(path, "r:gz") as tar:
        tar.extractall(dest)
    return True

def pack(dir_path, out_tar):
    with tarfile.open(out_tar, "w:gz") as tar:
        tar.add(dir_path, arcname=".")

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--models_dir")
    parser.add_argument("--preprocess_dir")
    parser.add_argument("--output_dir")
    args = parser.parse_args()

    os.makedirs(args.output_dir, exist_ok=True)

    preprocess_artifacts = glob.glob(os.path.join(args.preprocess_dir, "labelenc_*.pkl"))
    meta_file = os.path.join(args.preprocess_dir, "preprocess_meta.json")

    for tgt in os.listdir(args.models_dir):
        tgt_model_dir = os.path.join(args.models_dir, tgt)
        if not os.path.isdir(tgt_model_dir):
            continue

        # model.tar.gz from training step
        model_tar = os.path.join(tgt_model_dir, "model.tar.gz")
        extract_dir = os.path.join(tgt_model_dir, "extracted")
        os.makedirs(extract_dir, exist_ok=True)

        safe_extract_tar(model_tar, extract_dir)

        # Where the extracted artifacts live
        xgb_model = os.path.join(extract_dir, "xgboost-model")
        class_map = os.path.join(extract_dir, "class_map.json")

        packaging_dir = os.path.join(args.output_dir, tgt)
        os.makedirs(packaging_dir, exist_ok=True)

        # Copy model artifacts
        shutil.copy(xgb_model, packaging_dir)
        shutil.copy(class_map, packaging_dir)

        # Metadata
        if os.path.exists(meta_file):
            shutil.copy(meta_file, packaging_dir)

        # Optional encoders
        for art in preprocess_artifacts:
            shutil.copy(art, packaging_dir)

        # inference script
        shutil.copy("inference.py", packaging_dir)

        # Create final .tar.gz for MME
        out_tar = os.path.join(args.output_dir, f"{tgt}.tar.gz")
        pack(packaging_dir, out_tar)
        print(f"Packaged MME model for target {tgt}: {out_tar}")

if __name__ == "__main__":
    main()
