%%writefile repack_for_mme.py
import argparse
import os
import tarfile
import shutil
import glob

def safe_copy(src, dst):
    """Copy only if src exists and is not None."""
    if src is None:
        print(f"[WARN] Attempted to copy None → skipping")
        return
    if not os.path.exists(src):
        print(f"[WARN] Missing file: {src} → skipping")
        return
    shutil.copy(src, dst)

def pack(source_dir, output_tar):
    with tarfile.open(output_tar, "w:gz") as tar:
        tar.add(source_dir, arcname=".")

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--models_dir")
    parser.add_argument("--preprocess_dir")
    parser.add_argument("--output_dir")
    args = parser.parse_args()

    os.makedirs(args.output_dir, exist_ok=True)

    # dynamic files
    preprocess_artifacts = glob.glob(os.path.join(args.preprocess_dir, "labelenc_*.pkl"))
    meta_file = os.path.join(args.preprocess_dir, "preprocess_meta.json")

    if not os.path.exists(meta_file):
        print(f"[ERROR] preprocess_meta.json missing at: {meta_file}")
        raise FileNotFoundError("preprocess_meta.json not found")

    for tgt in os.listdir(args.models_dir):
        tgt_model_dir = os.path.join(args.models_dir, tgt)
        if not os.path.isdir(tgt_model_dir):
            continue

        packaging_dir = os.path.join(args.output_dir, tgt)
        os.makedirs(packaging_dir, exist_ok=True)

        # model files
        safe_copy(os.path.join(tgt_model_dir, "xgboost-model"), packaging_dir)
        safe_copy(os.path.join(tgt_model_dir, "class_map.json"), packaging_dir)

        # metadata
        safe_copy(meta_file, packaging_dir)

        # label encoders (optional)
        for art in preprocess_artifacts:
            safe_copy(art, packaging_dir)

        # inference script (must exist in working directory)
        safe_copy("inference.py", packaging_dir)

        # Create tar.gz
        tar_path = os.path.join(args.output_dir, f"{tgt}.tar.gz")
        pack(packaging_dir, tar_path)
        print(f"Packaged model for {tgt}: {tar_path}")

if __name__ == "__main__":
    main()
