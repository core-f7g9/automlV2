%%writefile repack_for_mme.py
import argparse
import os
import tarfile
import shutil
import glob
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def list_dir(dirname, label):
    if not os.path.exists(dirname):
        logger.info("[%s] %s (does not exist)", label, dirname)
        return
    for root, dirs, files in os.walk(dirname):
        rel = os.path.relpath(root, dirname)
        logger.info("[%s] %s => dirs=%s files=%s", label, rel, dirs, files)

def find_model_tar(tgt_dir):
    candidates = [
        os.path.join(tgt_dir, "model.tar.gz"),
        os.path.join(tgt_dir, "output", "model.tar.gz")
    ]
    candidates.extend(glob.glob(os.path.join(tgt_dir, "**", "model.tar.gz"), recursive=True))
    for c in candidates:
        if os.path.exists(c):
            return c
    return None

def safe_extract(path, dest):
    try:
        with tarfile.open(path, "r:gz") as tar:
            tar.extractall(dest)
        return True
    except Exception as e:
        logger.error("Extraction failed for %s: %s", path, e)
        return False

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--models_dir")
    parser.add_argument("--preprocess_dir")
    parser.add_argument("--output_dir")
    args = parser.parse_args()

    logger.info("=== repack_for_mme START ===")
    logger.info("models_dir=%s", args.models_dir)
    logger.info("preprocess_dir=%s", args.preprocess_dir)
    logger.info("output_dir=%s", args.output_dir)

    os.makedirs(args.output_dir, exist_ok=True)

    preprocess_artifacts = glob.glob(os.path.join(args.preprocess_dir, "labelenc_*.pkl"))
    meta_file = os.path.join(args.preprocess_dir, "preprocess_meta.json")
    inference_script_src = "/opt/ml/processing/code/inference.py"

    for tgt in os.listdir(args.models_dir):
        tgt_dir = os.path.join(args.models_dir, tgt)
        if not os.path.isdir(tgt_dir):
            continue

        logger.info("------ TARGET: %s ------", tgt)
        model_tar = find_model_tar(tgt_dir)

        if not model_tar:
            logger.error("model.tar.gz not found for target %s", tgt)
            continue

        extract_dir = os.path.join(tgt_dir, "extract_tmp")
        if os.path.exists(extract_dir):
            shutil.rmtree(extract_dir)
        os.makedirs(extract_dir, exist_ok=True)

        if not safe_extract(model_tar, extract_dir):
            continue

        if not os.path.exists(os.path.join(extract_dir, "xgboost-model")):
            logger.error("xgboost-model missing for target %s", tgt)
            continue
        if not os.path.exists(os.path.join(extract_dir, "class_map.json")):
            logger.error("class_map.json missing for target %s", tgt)
            continue

        # Build final MME layout: /model + /code
        pkg_root = os.path.join(args.output_dir, f"{tgt}_pkg")
        if os.path.exists(pkg_root):
            shutil.rmtree(pkg_root)
        os.makedirs(pkg_root)

        model_dir = os.path.join(pkg_root, "model")
        code_dir = os.path.join(pkg_root, "code")
        os.makedirs(model_dir)
        os.makedirs(code_dir)

        # Move booster
        shutil.copy(os.path.join(extract_dir, "xgboost-model"), model_dir)

        # Move metadata
        shutil.copy(os.path.join(extract_dir, "class_map.json"), code_dir)

        if os.path.exists(meta_file):
            shutil.copy(meta_file, code_dir)

        for enc in preprocess_artifacts:
            shutil.copy(enc, code_dir)

        # Copy inference script
        shutil.copy(inference_script_src, os.path.join(code_dir, "inference.py"))

        # Create final tar
        out_tar = os.path.join(args.output_dir, f"{tgt}.tar.gz")
        logger.info("Building final tar: %s", out_tar)

        with tarfile.open(out_tar, "w:gz") as tar:
            for root, dirs, files in os.walk(pkg_root):
                for file in files:
                    full = os.path.join(root, file)
                    rel = os.path.relpath(full, pkg_root)
                    tar.add(full, arcname=rel)

        logger.info("SUCCESS packaged: %s", out_tar)

    logger.info("=== repack_for_mme DONE ===")

if __name__ == "__main__":
    main()
