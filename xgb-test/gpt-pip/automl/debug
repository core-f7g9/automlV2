import boto3
sm = boto3.client("sagemaker", region_name=region)

resp = sm.list_auto_ml_jobs(SortBy="CreationTime", SortOrder="Descending", MaxResults=20)
for j in resp["AutoMLJobSummaries"][:8]:
    name = j["AutoMLJobName"]
    if PROJECT_PREFIX in name:
        d = sm.describe_auto_ml_job(AutoMLJobName=name)
        print("\nJOB:", name)
        print("Status:", d.get("AutoMLJobStatus"), "Secondary:", d.get("AutoMLJobSecondaryStatus"))
        print("FailureReason:", d.get("FailureReason"))
        for r in d.get("PartialFailureReasons", []):
            print(" -", r.get("PartialFailureMessage"))


import json

def list_all_steps(exec_arn: str):
    steps = []
    token = None
    while True:
        kwargs = dict(PipelineExecutionArn=exec_arn, MaxResults=50)
        if token:
            kwargs["NextToken"] = token
        resp = sm.list_pipeline_execution_steps(**kwargs)
        steps.extend(resp.get("PipelineExecutionSteps", []))
        token = resp.get("NextToken")
        if not token:
            break
    return steps

steps = list_all_steps(execution.arn)

print("Steps:")
for s in steps:
    print(f"- {s['StepName']}: {s['StepStatus']} | Type={s.get('StepType')}")

# Find AutoML steps and print their metadata (this is where AutoML job info is stored)
automl_steps = [s for s in steps if s.get("StepType") == "AutoML"]
print("\nAutoML steps found:", len(automl_steps))

for s in automl_steps:
    print("\n=== STEP:", s["StepName"], "===")
    meta = s.get("Metadata", {})
    # Print whole metadata to see the exact key names in your account/SDK
    print(json.dumps(meta, indent=2, default=str))



def describe_automl_job_by_name(job_name: str):
    d = sm.describe_auto_ml_job(AutoMLJobName=job_name)
    print("\nJOB:", job_name)
    print("Status:", d.get("AutoMLJobStatus"))
    print("Secondary:", d.get("AutoMLJobSecondaryStatus"))
    print("FailureReason:", d.get("FailureReason"))
    pfr = d.get("PartialFailureReasons", [])
    if pfr:
        print("PartialFailureReasons:")
        for r in pfr:
            print(" -", r.get("PartialFailureMessage"))
    else:
        print("PartialFailureReasons: (none)")
    return d

# Example: replace with the actual name you saw in Cell B output
# describe_automl_job_by_name("<AutoMLJobName>")
