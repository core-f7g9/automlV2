import boto3
import time

sm = boto3.client("sagemaker", region_name=region)

AUTOPILOT_JOB_NAME = f"ap-{PROJECT_PREFIX}-{TARGET}".lower().replace("_", "-")

train_path = f"s3://{BUCKET}/{PROJECT_PREFIX}/ap/{TARGET}/train.csv"
val_path   = f"s3://{BUCKET}/{PROJECT_PREFIX}/ap/{TARGET}/val.csv"

train_df.to_csv("/tmp/train.csv", index=False)
val_df.to_csv("/tmp/val.csv", index=False)

boto3.client("s3").upload_file("/tmp/train.csv", BUCKET, f"{PROJECT_PREFIX}/ap/{TARGET}/train.csv")
boto3.client("s3").upload_file("/tmp/val.csv", BUCKET, f"{PROJECT_PREFIX}/ap/{TARGET}/val.csv")

sm.create_auto_ml_job(
    AutoMLJobName=AUTOPILOT_JOB_NAME,
    InputDataConfig=[
        {
            "DataSource": {
                "S3DataSource": {
                    "S3DataType": "S3Prefix",
                    "S3Uri": train_path,
                }
            },
            "TargetAttributeName": TARGET,
            "ContentType": "text/csv",
        }
    ],
    OutputDataConfig={"S3OutputPath": f"s3://{BUCKET}/{PROJECT_PREFIX}/ap-output"},
    AutoMLJobConfig={
        "CompletionCriteria": {"MaxCandidates": 10}
    },
    RoleArn=role,
    ProblemType="MulticlassClassification",
    AutoMLJobObjective={"MetricName": "Accuracy"},
)

# Wait
while True:
    desc = sm.describe_auto_ml_job(AutoMLJobName=AUTOPILOT_JOB_NAME)
    status = desc["AutoMLJobStatus"]
    print("Autopilot status:", status)
    if status in ("Completed", "Failed"):
        break
    time.sleep(60)
