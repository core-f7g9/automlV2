import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split

# Reuse existing globals
INPUT_S3 = INPUT_S3
TARGET_COLS = TARGET_COLS
INPUT_FEATURES = INPUT_FEATURES

def valid_target_mask(series):
    s = series.astype(str).str.strip()
    return ~(
        series.isna() |
        s.isin({"", "nan", "NaN", "none", "None", "null", "NULL"})
    )

df = pd.read_csv(INPUT_S3)
print("Total rows:", len(df))

TARGET = "DepartmentCode"   # <<< test ONE target first

df_t = df.loc[valid_target_mask(df[TARGET]), INPUT_FEATURES + [TARGET]].copy()
df_t[TARGET] = df_t[TARGET].astype(str).str.strip()

train_df, val_df = train_test_split(
    df_t,
    test_size=0.2,
    random_state=42,
    shuffle=True,
    stratify=df_t[TARGET] if df_t[TARGET].value_counts().min() >= 2 else None
)

print("Train rows:", len(train_df))
print("Val rows:", len(val_df))
print("Classes:", train_df[TARGET].nunique())
