%%writefile deploy_endpoint.py
import argparse
import boto3
import botocore
import os


def safe_delete_endpoint(sm, endpoint_name: str):
    try:
        sm.delete_endpoint(EndpointName=endpoint_name)
        print(f"[deploy] Deleted endpoint: {endpoint_name}")
    except botocore.exceptions.ClientError as e:
        print(f"[deploy] delete_endpoint skipped: {e.response.get('Error', {}).get('Message')}")


def safe_delete_endpoint_config(sm, config_name: str):
    try:
        sm.delete_endpoint_config(EndpointConfigName=config_name)
        print(f"[deploy] Deleted endpoint config: {config_name}")
    except botocore.exceptions.ClientError as e:
        print(f"[deploy] delete_endpoint_config skipped: {e.response.get('Error', {}).get('Message')}")


def safe_delete_model(sm, model_name: str):
    try:
        sm.delete_model(ModelName=model_name)
        print(f"[deploy] Deleted model: {model_name}")
    except botocore.exceptions.ClientError as e:
        print(f"[deploy] delete_model skipped: {e.response.get('Error', {}).get('Message')}")


def main():
    # ---------------- Region setup ----------------
    region = os.environ.get("AWS_REGION") or os.environ.get("AWS_DEFAULT_REGION")
    if not region:
        raise ValueError("AWS_REGION / AWS_DEFAULT_REGION not set in environment")
    print("[deploy] Using region:", region)

    sm = boto3.client("sagemaker", region_name=region)

    # ---------------- Parse args ----------------
    parser = argparse.ArgumentParser()
    parser.add_argument("--model_name")
    parser.add_argument("--endpoint_config_name")
    parser.add_argument("--endpoint_name")
    parser.add_argument("--image_uri")
    parser.add_argument("--model_data")
    parser.add_argument("--instance_type")
    parser.add_argument("--instance_count", type=int, default=1)
    args = parser.parse_args()

    print("[deploy] Args:", args)

    # ---------------- Infer ExecutionRoleArn from this processing job ----------------
    processing_job_name = os.environ.get("PROCESSING_JOB_NAME")
    if not processing_job_name:
        raise ValueError("PROCESSING_JOB_NAME not set â€“ are we running inside a Processing job?")

    print("[deploy] Describe processing job:", processing_job_name)
    desc = sm.describe_processing_job(ProcessingJobName=processing_job_name)
    role_arn = desc["RoleArn"]
    print("[deploy] Using RoleArn from processing job:", role_arn)

    # ---------------- Clean up old resources ----------------
    safe_delete_endpoint(sm, args.endpoint_name)
    safe_delete_endpoint_config(sm, args.endpoint_config_name)
    safe_delete_model(sm, args.model_name)

    # ---------------- Create new model ----------------
    print("[deploy] Creating model...")
    sm.create_model(
        ModelName=args.model_name,
        PrimaryContainer={
            "Image": args.image_uri,
            "ModelDataUrl": args.model_data,
        },
        ExecutionRoleArn=role_arn,
    )
    print("[deploy] Created model:", args.model_name)

    # ---------------- Create endpoint config ----------------
    print("[deploy] Creating endpoint config...")
    sm.create_endpoint_config(
        EndpointConfigName=args.endpoint_config_name,
        ProductionVariants=[
            {
                "VariantName": "AllTraffic",
                "ModelName": args.model_name,
                "InstanceType": args.instance_type,
                "InitialInstanceCount": args.instance_count,
            }
        ],
    )
    print("[deploy] Created endpoint config:", args.endpoint_config_name)

    # ---------------- Create endpoint ----------------
    print("[deploy] Creating endpoint...")
    sm.create_endpoint(
        EndpointName=args.endpoint_name,
        EndpointConfigName=args.endpoint_config_name,
    )
    print("[deploy] Endpoint creation started:", args.endpoint_name)


if __name__ == "__main__":
    main()
