%%writefile create_model.py
import boto3
import json

def lambda_handler(event, context):
    """
    Creates (or replaces) a SageMaker model object pointing to:
    - Your custom ECR image
    - The combined model.tar.gz produced by the pipeline
    """

    sm = boto3.client("sagemaker")

    model_name = event["model_name"]
    image_uri  = event["image_uri"]
    model_data = event["model_data"]
    role       = event["role"]

    print(f"[create_model] ModelName={model_name}")
    print(f"[create_model] ImageUri={image_uri}")
    print(f"[create_model] ModelData={model_data}")

    # Delete existing model if present
    try:
        sm.delete_model(ModelName=model_name)
        print(f"[create_model] Deleted existing model: {model_name}")
    except Exception as e:
        print(f"[create_model] No existing model to delete: {e}")

    # Create new model
    sm.create_model(
        ModelName=model_name,
        PrimaryContainer={
            "Image": image_uri,
            "ModelDataUrl": model_data
        },
        ExecutionRoleArn=role
    )

    print(f"[create_model] Created model: {model_name}")
    return {"status": "model-created", "model_name": model_name}
