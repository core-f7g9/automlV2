%%writefile evaluate_automl.py
import os
import json
import boto3
from datetime import datetime

def main():
    job_name = os.environ["AUTOML_JOB_NAME"]
    target = os.environ["TARGET_COL"]
    out_dir = os.environ.get("OUTPUT_DIR", "/opt/ml/processing/output")

    sm = boto3.client("sagemaker")
    # V2 describe
    resp = sm.describe_auto_ml_job_v2(AutoMLJobName=job_name)

    status = resp.get("AutoMLJobStatus")
    best = resp.get("BestCandidate", {})

    # BestCandidate structure can vary; capture raw for safety
    report = {
        "target": target,
        "job_name": job_name,
        "status": status,
        "timestamp": datetime.utcnow().isoformat() + "Z",
        "best_candidate": best,
    }

    os.makedirs(out_dir, exist_ok=True)
    out_path = os.path.join(out_dir, "evaluation.json")
    with open(out_path, "w") as f:
        json.dump(report, f, indent=2, default=str)

    print(json.dumps(report, indent=2, default=str))
    print("Wrote:", out_path)

if __name__ == "__main__":
    main()
