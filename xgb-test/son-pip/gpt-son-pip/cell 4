from sagemaker.automl.automl import AutoML
from sagemaker.workflow.automl_step import AutoMLStep
from sagemaker.inputs import TrainingInput
from sagemaker.workflow.functions import Join

automl_steps = {}

for t in TARGET_LIST:
    train_s3_uri = Join(on="/", values=[p_artifacts_root, p_project, "prepared", t, "train.csv"])
    target_out = Join(on="/", values=[p_artifacts_root, p_project, "automl", t])

    automl = AutoML(
        role=role,
        target_attribute_name=t,
        sagemaker_session=pipeline_session,
        output_path=target_out,
        max_candidates=p_max_candidates,
        max_runtime_per_training_job_in_seconds=p_max_runtime_per_job,
        max_total_runtime_in_seconds=p_max_total_job,
        problem_type=p_problem_type,                 # if your SDK rejects, change to "Auto"
        objective_metric_name=p_objective_metric,    # if your SDK rejects, remove this line
    )

    # Training mode: if you want ENSEMBLING/HPO explicitly, set automl.mode = ...
    # Many SDK versions handle mode via AutoML(..., mode="ENSEMBLING") but not all.
    # Keep it AUTO unless you know your version supports it.

    automl_step = AutoMLStep(
        name=f"AutoML_{t}",
        automl=automl,
        inputs=TrainingInput(
            s3_data=train_s3_uri,
            content_type="text/csv",
        ),
    )

    automl_steps[t] = automl_step
