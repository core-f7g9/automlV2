from sagemaker.lambda_helper import Lambda
from sagemaker.workflow.lambda_step import LambdaStep, LambdaOutput
from sagemaker.workflow.model_step import ModelStep
from sagemaker.model import Model
from sagemaker.workflow.properties import PropertyFile

# Upload lambda code and create Lambda function
lambda_fn = Lambda(
    function_name=f"{sm_session.account_id()}-{region}-autopilot-best-model",
    execution_role_arn=role,
    script="autopilot_best_model_lambda.py",
    handler="autopilot_best_model_lambda.handler",
    timeout=120,
    memory_size=256,
)

steps = [prep_step]

for t in TARGET_LIST:
    aml = automl_steps[t]

    # Add AutoML step after prep
    steps.append(aml)

    # Evaluation step (writes evaluation.json)
    eval_processor = ScriptProcessor(
        image_uri=sagemaker.image_uris.retrieve("sklearn", region=region, version="1.2-1"),
        command=["python3"],
        role=role,
        instance_count=1,
        instance_type="ml.m5.large",
        sagemaker_session=pipeline_session,
    )

    eval_out = ProcessingOutput(
        output_name=f"eval_{t}",
        source="/opt/ml/processing/output",
        destination=Join(on="/", values=[p_artifacts_root, p_project, "evaluation", t]),
    )

    eval_step = ProcessingStep(
        name=f"Evaluate_{t}",
        processor=eval_processor,
        code="evaluate_automl.py",
        env={
            "AUTOML_JOB_NAME": aml.properties.AutoMLJobName,  # generated job name
            "TARGET_COL": t,
            "OUTPUT_DIR": "/opt/ml/processing/output"
        },
        outputs=[eval_out],
    )
    steps.append(eval_step)

    # LambdaStep: normalize best candidate => {image_uri, model_data_url}
    lambda_step = LambdaStep(
        name=f"ExtractBestModel_{t}",
        lambda_func=lambda_fn,
        inputs={
            "AutoMLJobName": aml.properties.AutoMLJobName,
            "Target": t
        },
        outputs=[
            LambdaOutput(output_name="image_uri", output_type="String"),
            LambdaOutput(output_name="model_data_url", output_type="String"),
            LambdaOutput(output_name="ok", output_type="Boolean"),
        ],
    )
    steps.append(lambda_step)

    # Create a SageMaker Model from the extracted artifacts
    model = Model(
        image_uri=lambda_step.properties.Outputs["image_uri"],
        model_data=lambda_step.properties.Outputs["model_data_url"],
        role=role,
        sagemaker_session=pipeline_session,
    )

    create_model_step = ModelStep(
        name=f"CreateModel_{t}",
        step_args=model.create(instance_type="ml.m5.large"),
    )
    steps.append(create_model_step)

    # RegisterModel (Model Package) so you can approve/deploy consistently
    register_step = RegisterModel(
        name=f"RegisterModel_{t}",
        model=model,
        content_types=["text/csv", "application/json"],
        response_types=["application/json"],
        inference_instances=["ml.m5.large", "ml.m5.xlarge"],
        transform_instances=["ml.m5.large"],
        model_package_group_name=f"{p_project}-{t}".replace("_", "-"),
        approval_status="PendingManualApproval",
    )
    steps.append(register_step)
