%%writefile autopilot_best_model_lambda.py
import json
import boto3

def handler(event, context):
    job_name = event["AutoMLJobName"]
    target = event.get("Target", "unknown")

    sm = boto3.client("sagemaker")
    resp = sm.describe_auto_ml_job_v2(AutoMLJobName=job_name)
    best = resp.get("BestCandidate", {})

    # Attempt to locate inference container info (structure varies)
    # Common patterns: "InferenceContainers" list with Image/ModelDataUrl OR similar nested fields.
    image = None
    model_data = None

    # Pattern 1
    if "InferenceContainers" in best and best["InferenceContainers"]:
        c0 = best["InferenceContainers"][0]
        image = c0.get("Image") or c0.get("ImageUri")
        model_data = c0.get("ModelDataUrl") or c0.get("ModelDataUri")

    # Pattern 2 (some responses use "ContainerDefinitions")
    if (image is None or model_data is None) and "ContainerDefinitions" in best and best["ContainerDefinitions"]:
        c0 = best["ContainerDefinitions"][0]
        image = c0.get("Image") or c0.get("ImageUri")
        model_data = c0.get("ModelDataUrl") or c0.get("ModelDataUri")

    if image is None or model_data is None:
        return {
            "ok": False,
            "target": target,
            "job_name": job_name,
            "message": "Could not locate image/model_data in BestCandidate",
            "best_candidate": best,
        }

    return {
        "ok": True,
        "target": target,
        "job_name": job_name,
        "image_uri": image,
        "model_data_url": model_data,
        "best_candidate": best,
    }
