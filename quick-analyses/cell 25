import matplotlib.pyplot as plt
from pandas.api.types import is_datetime64_any_dtype

# --- Incident volume attribution ---
# Set these to your incident window
INCIDENT_START = "2024-01-01"
INCIDENT_END = "2024-01-07"
TOP_THEMES_ATTRIBUTION = 10

def ensure_datetime(col_name, fallback_cols):
    if col_name in df.columns and is_datetime64_any_dtype(df[col_name]):
        return
    for src in fallback_cols:
        if src in df.columns:
            df[col_name] = pd.to_datetime(df[src], errors="coerce")
            return
    df[col_name] = pd.to_datetime(df.get(col_name), errors="coerce")


ensure_datetime("opened_at", ["Date/Time opened", "Opened At"])

start = pd.to_datetime(INCIDENT_START)
end = pd.to_datetime(INCIDENT_END)
if pd.isna(start) or pd.isna(end):
    raise ValueError("Set INCIDENT_START and INCIDENT_END to valid dates.")

incident_df = df[(df["opened_at"] >= start) & (df["opened_at"] <= end)].copy()
if incident_df.empty:
    raise ValueError("No tickets in the incident window. Check dates.")

# Baseline window: same length immediately before incident
window_days = (end - start).days + 1
baseline_start = start - pd.Timedelta(days=window_days)
baseline_end = start - pd.Timedelta(days=1)

baseline_df = df[(df["opened_at"] >= baseline_start) & (df["opened_at"] <= baseline_end)].copy()

incident_counts = incident_df[THEME_COL].value_counts()
baseline_counts = baseline_df[THEME_COL].value_counts()

attrib = (
    pd.DataFrame({
        "incident": incident_counts,
        "baseline": baseline_counts
    })
    .fillna(0)
)

attrib["delta"] = attrib["incident"] - attrib["baseline"]
attrib["incident_share"] = attrib["incident"] / attrib["incident"].sum()

attrib = attrib.sort_values(["incident_share", "delta"], ascending=[False, False])

print("Incident volume attribution (top themes):")
display(attrib.head(15))

top_attr = attrib.head(TOP_THEMES_ATTRIBUTION)
plt.figure()
top_attr["incident_share"].plot(kind="bar")
plt.title("Incident volume share by theme")
plt.xlabel("Theme")
plt.ylabel("Share of incident tickets")
plt.show()

plt.figure()
top_attr["delta"].plot(kind="bar")
plt.title("Incident vs baseline volume delta by theme")
plt.xlabel("Theme")
plt.ylabel("Ticket count delta")
plt.show()
