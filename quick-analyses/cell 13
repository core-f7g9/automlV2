import boto3, numpy as np, pandas as pd
from sklearn.metrics.pairwise import cosine_distances

# -------- CONFIG --------
MODEL_ID = "anthropic.claude-3-haiku-20240307-v1:0"  # very reliable for instruction following
REPRESENTATIVE_N = 6                                # full tickets are OK
MAX_TEXT_CHARS = 1200                               # plenty of context
SUBJECT_COL = "Subject"
# -----------------------

brt = boto3.client("bedrock-runtime", region_name=boto3.Session().region_name)

def truncate(s, n):
    s = "" if s is None else str(s).replace("\n", " ").strip()
    return s[:n]

def invoke_claude(prompt: str) -> str:
    body = {
        "messages": [
            {"role": "user", "content": prompt}
        ],
        "max_tokens": 120,
        "temperature": 0.0
    }

    resp = brt.invoke_model(
        modelId=MODEL_ID,
        body=json.dumps(body),
        accept="application/json",
        contentType="application/json",
    )
    out = json.loads(resp["body"].read())
    return out["content"][0]["text"].strip()

rows = []
centers = kmeans_emb.cluster_centers_

for theme_id in range(NUM_THEMES_EMB):
    mask = work_emb["theme_cluster_emb"] == theme_id
    if mask.sum() == 0:
        continue

    theme_vectors = embeddings[mask]
    theme_rows = work_emb.loc[mask]

    dists = cosine_distances(theme_vectors, centers[theme_id].reshape(1, -1)).flatten()
    top_idx = np.argsort(dists)[:REPRESENTATIVE_N]
    reps = theme_rows.iloc[top_idx]

    # Build readable examples (full subject + partial description)
    examples = []
    for _, r in reps.iterrows():
        text = f"Subject: {r.get(SUBJECT_COL,'')}\n{text:=r.get('text','')}"
        examples.append(truncate(text, MAX_TEXT_CHARS))

    prompt = f"""
You are labeling a cluster of support tickets.

Based on the examples below, provide:
- ONE concise theme label (3â€“7 words)
- Use business-friendly language
- Do NOT include explanations, bullets, or formatting
- Just return the label text

Ticket examples:
----------------
{chr(10).join(examples)}
""".strip()

    try:
        label = invoke_claude(prompt)
    except Exception as e:
        label = f"(error: {str(e)})"

    rows.append({
        "theme_cluster_emb": theme_id,
        "tickets": int(mask.sum()),
        "label": label
    })

label_df = pd.DataFrame(rows).sort_values("tickets", ascending=False)
display(label_df)
